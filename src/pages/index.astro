---
import Layout from '../layouts/Layout.astro';
import Dashboard from '../components/Dashboard';

const WORKER_API_URL = import.meta.env.PUBLIC_WORKER_API_URL || 'https://lcd.jxh.io';

let historyData: Array<{
  timestamp: number;
  total_easy: number;
  total_medium: number;
  total_hard: number;
  tags_json: string;
  beats_json?: string;
}> = [];

try {
  const response = await fetch(`${WORKER_API_URL}/api/history`);
  if (response.ok) {
    const data = await response.json();
    if (Array.isArray(data) && data.length > 0) {
      historyData = data;
    } else {
      throw new Error('API returned empty data');
    }
  } else {
    throw new Error('Failed to fetch history');
  }
} catch (error) {
  console.warn('Using mock data:', error);

  const now = Date.now();
  const day = 24 * 60 * 60 * 1000;

  const mockSkills = {
    advanced: [
      { tagName: 'Dynamic Programming', tagSlug: 'dynamic-programming', problemsSolved: 15 },
      { tagName: 'Binary Search', tagSlug: 'binary-search', problemsSolved: 12 },
      { tagName: 'Graph', tagSlug: 'graph', problemsSolved: 8 },
    ],
    intermediate: [
      { tagName: 'Hash Table', tagSlug: 'hash-table', problemsSolved: 25 },
      { tagName: 'Two Pointers', tagSlug: 'two-pointers', problemsSolved: 18 },
      { tagName: 'Sliding Window', tagSlug: 'sliding-window', problemsSolved: 10 },
      { tagName: 'Stack', tagSlug: 'stack', problemsSolved: 14 },
    ],
    fundamental: [
      { tagName: 'Array', tagSlug: 'array', problemsSolved: 45 },
      { tagName: 'String', tagSlug: 'string', problemsSolved: 30 },
      { tagName: 'Linked List', tagSlug: 'linked-list', problemsSolved: 12 },
      { tagName: 'Math', tagSlug: 'math', problemsSolved: 8 },
    ],
  };

  const mockBeats = { easy: 78.5, medium: 62.3, hard: 45.8 };

  historyData = [];
  for (let i = 30; i >= 0; i--) {
    const progress = 30 - i;
    historyData.push({
      timestamp: now - i * day,
      total_easy: 10 + Math.floor(progress * 0.8) + Math.floor(Math.random() * 2),
      total_medium: 5 + Math.floor(progress * 0.5) + Math.floor(Math.random() * 2),
      total_hard: 1 + Math.floor(progress * 0.2),
      tags_json: JSON.stringify(mockSkills),
      beats_json: JSON.stringify(mockBeats),
    });
  }
}

const currentStats = historyData[historyData.length - 1] || {
  timestamp: Date.now(),
  total_easy: 0,
  total_medium: 0,
  total_hard: 0,
  tags_json: JSON.stringify({}),
  beats_json: JSON.stringify({}),
};
---

<Layout title="LeetCode Stats">
  <main class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-white">leetcode progress</h1>
      <Dashboard client:load history={historyData} current={currentStats} />
    </div>
  </main>
</Layout>
